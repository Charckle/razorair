{% extends "main_page_module/base.html" %}

{% block extraheader %}
{% endblock extraheader  %}

{% block nav_index %}text-secondary{% endblock nav_index %}



{% block content%}

  <div class="container-fluid" >
    <br>
    <div class="row">
      <div class="col-sm-3">
        <table class="table">
          <tbody>
            <tr>
              <th scope="row">Rekuperator</th>
              <td><span id="exchangerbadge" class="badge text-bg-secondary">Ne deluje</span></td>
            </tr>
            <tr>
              <th scope="row">Grelec</th>
              <td><span id="heaterbadge" class="badge text-bg-secondary">Ne deluje</span></td>
            </tr>
            <tr>
              <th scope="row">Centralna</th>
              <td><span id="centralheatingbadge" class="badge text-bg-secondary">Ne deluje</span></td>
            </tr>
            <tr>
              <th scope="row">Električna tarifa</th>
              <td><span class="badge text-bg-danger">Visoka</span><span class="badge text-bg-secondary">Še 3h</span></td>
            </tr>
          </tbody>
        </table>

        <table class="table">
          <tbody>
            
            <tr>
              <th rowspan="2" class="text-center align-middle"><img id="home_icon" style="height: 80px;" src="{{ url_for('static', filename='main_page_module/icons/weather/fill/not-available.svg') }}" alt=""></th>
              <th scope="col"><i class="bi bi-house-fill"></i> Notranja temperatura</th>
              <th scope="col"><i class="bi bi-house-fill"></i> <i class="bi bi-droplet"></i> Vlažnost</th>
              <th scope="col"><i class="bi bi-cloud"></i> Zunanja temperatura</th>
            </tr>
            <tr>
              <td><span id="inhouse_t"></span>°C</td>
              <td><span id="inhouse_humidity"></span>%</td>
              <td><span id="outside_t"></span>°C</td>
            </tr>

          </tbody>
        </table>


      </div>
      
      
      <div class="col-sm-6">
        <legend>Opozorila</legend>
        <hr>

        <div id="warnings_container" class="list-group">
          <!-- Warnings will be dynamically inserted here -->
        </div>
        
      </div>


        
      <div class="col-sm-3">
        <h5>Željena temperatura</h5>

        <div class="input-group">
          <button class="btn btn-outline-primary  btn-lg" type="button" id="minusBtn"  style="flex-basis: 30%;"><img style="max-height: 50px;" src="{{ url_for('static', filename='main_page_module/icons/weather/fill/thermometer-colder.svg') }}" alt=""></button>
          <input type="number" class="form-control text-center" id="req_t" value="22" min="12" max="30" step="0.5" readonly style="flex-basis: 40%;">
          <button class="btn btn-outline-danger  btn-lg" type="button" id="plusBtn"  style="flex-basis: 30%;"><img style="max-height: 50px;" src="{{ url_for('static', filename='main_page_module/icons/weather/fill/thermometer-warmer.svg') }}" alt=""></button>
        </div>
        

        <script>
          // Get the elements
          const minusBtn = document.getElementById('minusBtn');
          const plusBtn = document.getElementById('plusBtn');
          const temperatureInput = document.getElementById('req_t');
        
          // Set increment and decrement functions with 0.5 degree precision
          minusBtn.addEventListener('click', () => {
            const currentTemp = parseFloat(temperatureInput.value);
            if (currentTemp > parseFloat(temperatureInput.min)) {
              temperatureInput.value = (currentTemp - 0.5).toFixed(1);
            }
            set_shelly_thermostat_temp();
          });
        
          plusBtn.addEventListener('click', () => {
            const currentTemp = parseFloat(temperatureInput.value);
            if (currentTemp < parseFloat(temperatureInput.max)) {
              temperatureInput.value = (currentTemp + 0.5).toFixed(1);
            }
            set_shelly_thermostat_temp();
          });
        </script>

<br>
        <h5>Ventilacija</h5>

        <div class="input-group">
          <button class="btn btn-outline-danger btn-lg" type="button" id="minusBtn_vnt" style="flex-basis: 30%;">
              <img style="max-height: 50px;" src="{{ url_for('static', filename='main_page_module/icons/weather/fill/wind-beaufort-1.svg') }}" alt="">
          </button>
          
          <input type="text" class="form-control text-center" id="speedInput" value="Stopped" readonly style="flex-basis: 40%;">
      
          <button class="btn btn-outline-success btn-lg" type="button" id="plusBtn_vnt" style="flex-basis: 30%;">
              <img style="max-height: 50px;" src="{{ url_for('static', filename='main_page_module/icons/weather/fill/wind-beaufort-12.svg') }}" alt="">
          </button>
      </div>

      <br>

      <h5>Kotel</h5>

      <div class="d-grid gap-2">
        <div class="btn-group">
          <button id="kotel_off_btn" class="btn btn-outline-danger btn-lg" type="button" onclick="sendThermostatRequest(0)"><i class="bi bi-ban"></i> Off</button>
          <button id="kotel_on_btn" class="btn btn-success btn-lg" type="button" onclick="sendThermostatRequest(1)"><i class="bi bi-fire"></i> On</button>
        </div>
      </div>

      <hr>

      <script>
        // Define the available options
        const speedLevels = [
            { text: "Stopped", value: 0 },
            { text: "Slow", value: 2 },
            { text: "Medium", value: 3 },
            { text: "Max", value: 4 }
        ];
    
        let currentVent_speedIndex = 0; // Default to "Stopped"
    
        const speedInput = document.getElementById("speedInput");
        const minusBtn_vnt = document.getElementById("minusBtn_vnt");
        const plusBtn_vnt = document.getElementById("plusBtn_vnt");
    
        function updateVentSpeedDisplay() {
            speedInput.value = speedLevels[currentVent_speedIndex].text;
            speedInput.dataset.value = speedLevels[currentVent_speedIndex].value; // Store numeric value in data attribute
        }
    
        minusBtn_vnt.addEventListener("click", function () {
            if (currentVent_speedIndex > 0) {
              currentVent_speedIndex--;
                updateVentSpeedDisplay();
                set_hvac_vent_temp();
            }
        });
    
        plusBtn_vnt.addEventListener("click", function () {
            if (currentVent_speedIndex < speedLevels.length - 1) {
              currentVent_speedIndex++;
                updateVentSpeedDisplay();
                set_hvac_vent_temp();
            }
        });
    
        updateVentSpeedDisplay(); // Set initial value
    </script>
    

        
        
      </div>
    </div>

    <div id="hourly_weather_container" class="mb-4">
      <div class="card">
        <div class="card-body">
          <h5>Hourly Weather (Current Location)</h5>
          <div id="hourly_weather_div"></div>
        </div>
      </div>
    </div>

    <div id="cities_weather_container">
      <!-- Cities weather will be dynamically inserted here -->
    </div>

  </div>


<script>
  function update_data(){
    home_data();
    hvac_data();
    //thermostat_data();
    shelly_thermostat_data();
  }

  function set_home_data(home_data) {
    var cities = home_data["cities"] || [];
    var local = home_data["local"] || {};
    var hourly = home_data["hourly"] || {};
    var warnings = home_data["warnings"] || [];

    // Use local city's current weather for the home icon
    if (local["icon"]) {
      var home_icon = document.getElementById("home_icon");
      home_icon.src = local["icon"];
    }

    // Render hourly weather from current location (shown once at top)
    if (Object.keys(hourly).length > 0) {
      var hourlyContainer = document.getElementById("hourly_weather_container");
      if (hourlyContainer) {
        createHourlyTable(hourly, "hourly_weather_div");
      }
    }

    // Render warnings
    renderWarnings(warnings);

    // Render all cities (daily weather only)
    renderCitiesWeather(cities);
  }
  
  function renderWarnings(warnings) {
    var container = document.getElementById("warnings_container");
    container.innerHTML = "";
    
    if (warnings.length === 0) {
      return;
    }
    
    warnings.forEach(function(warning) {
      var warningItem = document.createElement("a");
      warningItem.href = "#";
      warningItem.className = "list-group-item list-group-item-action list-group-item-warning";
      
      var icon = document.createElement("i");
      if (warning.type === "high") {
        icon.className = "bi bi-thermometer-high";
      } else {
        icon.className = "bi bi-thermometer-low";
      }
      warningItem.appendChild(icon);
      
      warningItem.appendChild(document.createTextNode(" " + warning.message));
      
      container.appendChild(warningItem);
    });
  }
  
  function renderCitiesWeather(cities) {
    var container = document.getElementById("cities_weather_container");
    container.innerHTML = "";
    
    cities.forEach(function(city) {
      var cityName = city["name"] || "Unknown";
      var daily = city["daily"] || {};
      var cityId = cityName.replace(/\s+/g, "_");
      
      // Daily forecast row
      var dailyRow = document.createElement("div");
      dailyRow.className = "row mb-4";
      var dailyCol = document.createElement("div");
      dailyCol.className = "col-sm-12";
      
      var cityTitle = document.createElement("h5");
      cityTitle.textContent = cityName;
      dailyCol.appendChild(cityTitle);
      
      var dailyContainer = document.createElement("div");
      dailyContainer.className = "row";
      dailyContainer.id = "home_weather_" + cityId;
      dailyCol.appendChild(dailyContainer);
      
      dailyRow.appendChild(dailyCol);
      container.appendChild(dailyRow);
      
      // Render daily for this city
      createDailycards(daily, "home_weather_" + cityId);
    });
  }

  function convertTemperatures(rawTemp) {
    return (rawTemp / 10).toFixed(1);
  }

  function set_thermostat_data(thermo_data) {
    var centr_on = thermo_data["centr_on"];
    var is_on = thermo_data["is_on"];
    var set_temp = convertTemperatures(thermo_data["set_temp"]);
    var temp_ = convertTemperatures(thermo_data["temp_"]);
    console.log(centr_on);
    updateCentralHeatingBadge(centr_on, temp_)
  }

  function set_hvac_data(hvac_data) {
    var daily = hvac_data["daily"];

    // set outside temperature (internal temp now comes from Shelly thermostat)
    var outside_t = document.getElementById("outside_t");
    outside_t.innerHTML = hvac_data["outside_temp"];

    // set ventilation speed
    user_set_ventilation = hvac_data["user_set_ventilation"];
    currentVent_speedIndex = speedLevels.findIndex(level => level.value === user_set_ventilation);

    updateVentSpeedDisplay();
    updateHeaterBadge(hvac_data["heater_percentage"])
    updateExchangerBadge(hvac_data["heat_echanger_percentage"])
  }
  
  function set_shelly_thermostat_data(thermo_data) {
    // Update internal temperature from Shelly thermostat
    var inhouse_t = document.getElementById("inhouse_t");
    if (thermo_data && thermo_data["current_temp"] !== null && thermo_data["current_temp"] !== undefined) {
      inhouse_t.innerHTML = parseFloat(thermo_data["current_temp"]).toFixed(1);
    } else {
      console.log("Shelly thermostat: current_temp not available", thermo_data);
    }
    
    // Update humidity from Shelly thermostat
    var inhouse_humidity = document.getElementById("inhouse_humidity");
    if (thermo_data && thermo_data["current_humidity"] !== null && thermo_data["current_humidity"] !== undefined) {
      inhouse_humidity.innerHTML = parseFloat(thermo_data["current_humidity"]).toFixed(0);
    }
    
    // Update set temperature (refresh from device to show manual changes)
    var req_t = document.getElementById("req_t");
    if (thermo_data && thermo_data["set_temp"] !== null && thermo_data["set_temp"] !== undefined) {
      req_t.value = parseFloat(thermo_data["set_temp"]).toFixed(1);
    }
    
    // Update Kotel button states based on enabled status
    var kotel_off_btn = document.getElementById("kotel_off_btn");
    var kotel_on_btn = document.getElementById("kotel_on_btn");
    if (thermo_data && thermo_data["enabled"] !== null && thermo_data["enabled"] !== undefined) {
      var is_enabled = thermo_data["enabled"];
      if (is_enabled) {
        // Thermostat is enabled - highlight On button
        kotel_on_btn.classList.remove("btn-outline-success");
        kotel_on_btn.classList.add("btn-success");
        kotel_off_btn.classList.remove("btn-danger");
        kotel_off_btn.classList.add("btn-outline-danger");
      } else {
        // Thermostat is disabled - highlight Off button
        kotel_off_btn.classList.remove("btn-outline-danger");
        kotel_off_btn.classList.add("btn-danger");
        kotel_on_btn.classList.remove("btn-success");
        kotel_on_btn.classList.add("btn-outline-success");
      }
    }
  }
  
  function set_shelly_thermostat_temp() {
    var r_temp = document.getElementById("req_t").value;
    $.post("{{ url_for('hvac_api.shelly_thermostat_set_temp') }}", 
      {"temperature": r_temp}, 
      function(data, textStatus) {
        // Refresh thermostat data after setting to confirm
        shelly_thermostat_data();
      }, "json").fail(function(jqXHR, textStatus, errorThrown) {
        console.error("Error setting Shelly thermostat temperature:", errorThrown);
      });
  }
  
  function shelly_thermostat_data() {
    $.get("{{ url_for('hvac_api.shelly_thermostat_status') }}", {}, 
      function(data, textStatus, jqXHR) {
        if (jqXHR.status == 200) {
          set_shelly_thermostat_data(data);
        } else {
          console.log("Error getting Shelly thermostat data. Status:", jqXHR.status);
        }
      }, "json").fail(function(jqXHR, textStatus, errorThrown) {
        console.error("Error getting Shelly thermostat data:", errorThrown, "Status:", jqXHR.status);
      });
  }

  function createHourlyTable(hourly, containerId) {
    // Use provided container ID or default
    containerId = containerId || "hourly_table_div";
    var hourly_table_div = document.getElementById(containerId);
    
    if (!hourly_table_div) {
      console.error("Container not found: " + containerId);
      return;
    }
    
    // empty the div
    hourly_table_div.innerHTML = "";

    // Create scrollable container
    var scrollContainer = document.createElement('div');
    scrollContainer.className = "d-flex flex-nowrap overflow-auto pb-2";
    scrollContainer.style.cssText = "scrollbar-width: thin; -webkit-overflow-scrolling: touch;";
    hourly_table_div.appendChild(scrollContainer);

    // Create row for hourly items
    var hourlyRow = document.createElement('div');
    hourlyRow.className = "d-flex flex-nowrap gap-2";
    scrollContainer.appendChild(hourlyRow);

    // Helper function to format time
    function formatTime(dateStr) {
      var timePart = dateStr.split('T')[1];
      var [hours, minutes] = timePart.split(':');
      return hours + ':' + minutes;
    }

    // Create hourly cards
    for (let [date_, wd] of Object.entries(hourly)){
        var hourCard = document.createElement('div');
        hourCard.className = "text-center";
        hourCard.style.cssText = "min-width: 80px; flex-shrink: 0;";
        
        // Card container
        var card = document.createElement('div');
        card.className = "card h-100";
        if (wd["day"] == true) {
          card.style.cssText = "background: linear-gradient(135deg, #8BC8F0 0%, #5BA3D6 100%); border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);";
        } else {
          card.style.cssText = "background: linear-gradient(135deg, #4C87AC 0%, #2E5A7E 100%); border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15);";
        }
        hourCard.appendChild(card);

        var cardBody = document.createElement('div');
        cardBody.className = "card-body p-2 d-flex flex-column justify-content-center";
        card.appendChild(cardBody);

        // Time
        var timeEl = document.createElement('div');
        timeEl.className = "small mb-2 fw-bold";
        timeEl.style.cssText = "color: rgba(255,255,255,0.95); font-size: 0.75rem;";
        timeEl.textContent = formatTime(date_);
        cardBody.appendChild(timeEl);

        // Icon
        var iconContainer = document.createElement('div');
        iconContainer.className = "mb-2";
        cardBody.appendChild(iconContainer);

        var icon = document.createElement('img');
        icon.style.cssText = "max-height: 45px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));";
        icon.src = wd['icon'];
        icon.alt = "Weather icon";
        iconContainer.appendChild(icon);

        // Temperature
        var tempEl = document.createElement('div');
        tempEl.className = "fw-bold";
        tempEl.style.cssText = "color: white; font-size: 1.1rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);";
        tempEl.textContent = wd['temp'] + "°";
        cardBody.appendChild(tempEl);

        // Add hover effect
        hourCard.addEventListener('mouseenter', function() {
          card.style.transform = 'translateY(-4px)';
          card.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
          card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        });
        hourCard.addEventListener('mouseleave', function() {
          card.style.transform = 'translateY(0)';
          card.style.boxShadow = wd["day"] ? '0 2px 8px rgba(0,0,0,0.1)' : '0 2px 8px rgba(0,0,0,0.15)';
        });

        hourlyRow.appendChild(hourCard);
    }

  }

  function createDailycards(daily, containerId) {
    containerId = containerId || "home_weather";
    var home_weather_div = document.getElementById(containerId);
    
    if (!home_weather_div) {
      console.error("Container not found: " + containerId);
      return;
    }
    
    home_weather_div.innerHTML = "";

    for (let [date_, wd] of Object.entries(daily)){
      var row_col = document.createElement('div');
      row_col.className = "col-sm-1";
      home_weather_div.appendChild(row_col);

      var day_card = document.createElement('div');
      day_card.className = "card";
      row_col.appendChild(day_card);

      var day_card_body = document.createElement('div');
      day_card_body.className = "card-body text-center";
      day_card.appendChild(day_card_body);

      var day_name = document.createElement('p');
      day_name.className = "card-text";
      day_name.innerHTML = wd['day_name'];
      day_card_body.appendChild(day_name);

      var day_image = document.createElement('img');
      day_image.style = "max-height: 80px;";
      day_image.src = wd['icon'];
      day_card_body.appendChild(day_image);

      var day_temp = document.createElement('p');
      day_temp.className = "card-text";
      day_card_body.appendChild(day_temp);

      var day_temp_min = document.createElement('span');
      day_temp_min.style = "color:rgb(113, 161, 201)";
      day_temp_min.innerHTML = wd['temp_min'] + "°";
      day_temp.appendChild(day_temp_min);

      day_temp.innerHTML += " - ";

      var day_temp_max = document.createElement('span');
      day_temp_max.style = "color:rgb(226, 96, 96)";
      day_temp_max.innerHTML = wd['temp_max'] + "°";
      day_temp.appendChild(day_temp_max);
    }


  }


  function updateExchangerBadge(value) {
    var badge = document.getElementById("exchangerbadge");
    
    if (value > 0) {
      badge.classList.add('text-bg-success');
      badge.classList.remove('text-bg-secondary');
      badge.textContent= "Deluje: " + value + "%";
    } else {
      // Change class to "text-bg-secondary"
      badge.classList.remove('text-bg-success');
      badge.textContent= "Ne deluje";
      badge.classList.add('text-bg-secondary');
    }
  }

  function updateCentralHeatingBadge(is_heater_on, set_temp) {
    var badge = document.getElementById("centralheatingbadge");
    
    if (is_heater_on > 0) {
      badge.classList.add('text-bg-success');
      badge.classList.remove('text-bg-secondary');
      badge.textContent= "Deluje: " + set_temp + "°C";
    } else {
      // Change class to "text-bg-secondary"
      badge.classList.remove('text-bg-success');
      badge.textContent= "Ne deluje: " + set_temp + "°C";
      badge.classList.add('text-bg-secondary');
    }
  }


  function updateHeaterBadge(value) {
    var badge = document.getElementById("heaterbadge");
    
    if (value > 0) {
      badge.classList.add('text-bg-success');
      badge.classList.remove('text-bg-secondary');
      badge.textContent= "Deluje: " + value + "";
    } else {
      // Change class to "text-bg-secondary"
      badge.classList.remove('text-bg-success');
      badge.textContent= "Ne deluje";
      badge.classList.add('text-bg-secondary');
    }
  }

  function sendThermostatRequest(state) {
    const enabled = state === 1;
    const formData = new FormData();
    formData.append('enabled', enabled.toString());
    
    fetch("{{ url_for('hvac_api.shelly_thermostat_enable') }}", {
      method: 'POST',
      body: formData
    })
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(data => {
        console.log('Response:', data);
        // Refresh thermostat data after setting to confirm and update UI
        shelly_thermostat_data();
      })
      .catch(error => {
        console.error('Fetch error:', error);
        alert('Error: ' + error.message);
      });
  }

  function home_data(){

    $.get("{{ url_for('hvac_api.weather_home') }}", {}, function(data, textStatus, jqXHR) {
      //console.log(data["a"]);

      if (jqXHR.status == 200){
        set_home_data(data);


      } else {
        console.log("Error getting home data.");
      }      

    }, "json");

  };

  function set_hvac_vent_temp(){
      var r_vent = document.getElementById("speedInput").dataset.value;

      $.post("{{ url_for('hvac_api.hvac_data_set_vet_r_tmp') }}", {"user_set_temp": 0, "user_set_ventilation": r_vent}, function(data, textStatus) {

      }, "json");

    };



  function hvac_data(){

    $.get("{{ url_for('hvac_api.hvac_data_get') }}", {}, function(data, textStatus, jqXHR) {
      //console.log(data["a"]);

      if (jqXHR.status == 200){
        set_hvac_data(data);


      } else {
        console.log("Error getting home data.");
      }      

    }, "json");

  };


  function thermostat_data(){

    $.get("", {}, function(data, textStatus, jqXHR) {
      //console.log(data["a"]);

      if (jqXHR.status == 200){
        set_thermostat_data(data);


      } else {
        console.log("Error getting home data.");
      }      

    }, "json");

    };

  
  

  window.onload = function() {
    update_data();

    setInterval(hvac_data, 5000);
    //setInterval(thermostat_data, 5000);
    setInterval(shelly_thermostat_data, 5000);
    setInterval(home_data, 300000);
  };
</script>


{% endblock content %}
